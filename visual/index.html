<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cell Project Visual</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<script>
let socket = io();
let sensorData = { x: 0, y: 0 };
let cells = [];
let playerCell;

// ====== CONFIG ======
const CONFIG = {
  cellCount: 10,          // 普通细胞数量减少
  otherScaleMin: 15,
  otherScaleMax: 30,
  playerAlpha: 200,
  playerSize: 60,
  noiseDensity: 500       // 降低噪点
};

// ====== CELL CLASS ======
class BioCell {
  constructor(x, y, isPlayer) {
    this.pos = createVector(x, y);
    this.vel = createVector(0, 0);
    this.acc = createVector(0, 0);
    this.isPlayer = isPlayer;
    this.r = isPlayer ? CONFIG.playerSize : random(CONFIG.otherScaleMin, CONFIG.otherScaleMax);
  }

  applySensorForce(gx, gy) {
    if (this.isPlayer) this.acc.add(createVector(gx * 0.2, gy * 0.2));
  }

  update() {
    this.vel.add(this.acc);
    this.vel.limit(this.isPlayer ? 10 : 5);
    this.pos.add(this.vel);
    this.vel.mult(0.9);
    this.acc.mult(0);
  }

  display() {
    push();
    translate(this.pos.x, this.pos.y);
    if (this.isPlayer) {
      fill(50, 200, 100, CONFIG.playerAlpha);
      noStroke();
      ellipse(0, 0, this.r * 2);
    } else {
      noFill();
      stroke(100);
      ellipse(0, 0, this.r * 2);
    }
    pop();
  }

  checkEdges() {
    if (this.pos.x < this.r) this.pos.x = this.r;
    if (this.pos.x > width - this.r) this.pos.x = width - this.r;
    if (this.pos.y < this.r) this.pos.y = this.r;
    if (this.pos.y > height - this.r) this.pos.y = height - this.r;
  }
}

// ====== SETUP & DRAW ======
function setup() {
  createCanvas(windowWidth, windowHeight);
  // 初始化普通细胞
  for (let i = 0; i < CONFIG.cellCount; i++) {
    cells.push(new BioCell(random(width), random(height), false));
  }
  // 玩家
  playerCell = new BioCell(width / 2, height / 2, true);

  // Socket 监听手机数据
  socket.on("motion", (data) => {
    sensorData.x = data.x;
    sensorData.y = data.y;
  });
}

function draw() {
  background(240);

  // 玩家移动
  playerCell.applySensorForce(sensorData.x, sensorData.y);
  playerCell.update();
  playerCell.display();
  playerCell.checkEdges();

  // 普通细胞移动
  for (let c of cells) {
    c.update();
    c.display();
    c.checkEdges();
  }

  // 简单噪点背景
  stroke(0, 50);
  for (let i = 0; i < CONFIG.noiseDensity; i++) {
    point(random(width), random(height));
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
